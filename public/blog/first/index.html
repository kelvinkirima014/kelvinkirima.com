<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>The Mechanics of mutable references and dereference in Rust</title><meta content="The Mechanics of mutable references and dereference in Rust" name=title><meta content=website property=og:type><meta content=https://kelvinkirima.com/blog/first/ property=og:url><meta property=og:site_name><meta content="The Mechanics of mutable references and dereference in Rust" property=og:title><meta content=https://kelvinkirima.com/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://kelvinkirima.com/blog/first/ property=twitter:url><meta content="The Mechanics of mutable references and dereference in Rust" property=twitter:title><meta content=https://kelvinkirima.com/favicon.ico property=twitter:image><link href=https://kelvinkirima.com/blog/first/ rel=canonical><link rel="shortcut icon" href=https://kelvinkirima.com/favicon.ico type=image/x-icon><link href=https://kelvinkirima.com/css/style.css rel=stylesheet><script defer src=https://kelvinkirima.com/js/script.js></script><body><div class=wrapper><header><nav class=navBar><div class=profile-section><div class=home-link-container><a href=https://kelvinkirima.com> <img alt="Profile Picture" class=profile-pic src=https://kelvinkirima.com/logo.jpg> </a></div><div class=profile-info><span class=profile-text>Kirima</span><div class=nav-links><a href=/> Home </a><a href=/blog> Blog </a><a href=/faq> FAQ </a></div></div></div><div class=themeSwitch><button class="themeButton dark" onclick="setTheme('dark')" title="Dark mode"><svg class="icons icons__background"><use href=https://kelvinkirima.com/icons.svg#darkMode></use></svg></button><button class="themeButton light" onclick="setTheme('light')" title="Light mode"><svg class="icons icons__background"><use href=https://kelvinkirima.com/icons.svg#lightMode></use></svg></button></div></nav></header><main><div><a href=..>..</a>/<span class=metaData>first</span></div><time datetime=2024-01-22>Published on: <span class=metaData>2024-01-22</span></time><h1>The Mechanics of mutable references and dereference in Rust</h1><p>I was working with the sqlx library trying to create a database transaction that I could use to update the database and also insert into the database.<p>I created the tx like so:<pre class=language-rust data-lang=rust style=background:#2b303b;color:#c0c5ce><code class=language-rust data-lang=rust><span>	 	</span><span style=color:#65737e>//create a database transaction in order to be able
</span><span>    </span><span style=color:#65737e>//to insert and update the db atomically
</span><span>    </span><span style=color:#b48ead>let mut</span><span> tx = ctx.db.</span><span style=color:#96b5b4>begin</span><span>().await.</span><span style=color:#96b5b4>map_err</span><span>(| </span><span style=color:#bf616a>err </span><span>| {
</span><span>        error!("</span><span style=color:#a3be8c>error starting database transaction: {err}</span><span>");
</span><span>        ApiError::InternalServerError
</span><span>    })?;
</span></code></pre><p>I then intended to use the transaction as an executor to query the db for user insertion:<pre class=language-rust data-lang=rust style=background:#2b303b;color:#c0c5ce><code class=language-rust data-lang=rust><span style=color:#b48ead>let</span><span> new_user = sqlx::query_as!(
</span><span>        User,
</span><span>        </span><span style=color:#b48ead>r</span><span>#"
</span><span style=color:#a3be8c>            insert into users (username, referral_code, referred_by)
</span><span style=color:#a3be8c>            values ($1, $2, $3)
</span><span style=color:#a3be8c>            returning *
</span><span style=color:#a3be8c>        </span><span>"#,
</span><span>        new_username,
</span><span>        new_referral_code,
</span><span>        referrer.referral_code
</span><span>    )
</span><span>    .</span><span style=color:#96b5b4>fetch_one</span><span>(&</span><span style=color:#b48ead>mut</span><span> tx)
</span><span>    .await
</span><span>    .</span><span style=color:#96b5b4>map_err</span><span>(| </span><span style=color:#bf616a>err </span><span>| {
</span><span>        error!("</span><span style=color:#a3be8c>error creating new user from username: {err}</span><span>");
</span><span>        ApiError::InternalServerError
</span><span>    })?;
</span></code></pre><p>However, the code threw an error that goes like this:<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#bf616a>the</span><span> trait bound `&</span><span style=color:#bf616a>mut</span><span> Transaction<'</span><span style=color:#a3be8c>_, Postgres>: sqlx::Executor<</span><span>'_>` is not satisfied
</span><span style=color:#bf616a>the</span><span> following other types implement trait `</span><span style=color:#bf616a>sqlx::Executor</span><span><'</span><span style=color:#a3be8c>c>`:
</span><span style=color:#a3be8c>  <&</span><span>'c mut AnyConnection as sqlx::Executor<'</span><span style=color:#a3be8c>c>>
</span><span style=color:#a3be8c>  <&</span><span>'c mut PgConnection as sqlx::Executor<'</span><span style=color:#a3be8c>c>>
</span><span style=color:#a3be8c>  <&</span><span>'c mut PgListener as sqlx::Executor<'</span><span style=color:#a3be8c>c>>
</span><span style=color:#a3be8c>  <&Pool&LTDB> as sqlx::Executor<</span><span>'p>>rustcClick for full compiler diagnostic
</span><span style=color:#bf616a>signup.rs</span><span>(102, 6)</span><span style=color:#96b5b4>:</span><span> required by a bound introduced by this call
</span></code></pre><p>This error message is pointing out a trait-bound issue. Itâ€™s saying that the trait <strong><code>sqlx::Executor</code></strong> is not satisfied for the type <strong><code>&mut Transaction<'_, Postgres></code></strong>. However, it is satisfied for a few other types like <strong><code>&mut AnyConnection</code></strong>, <strong><code>&mut PgConnection</code></strong>, <strong><code>&mut PgListener</code></strong>, and <strong><code>&Pool&LTDB></code></strong>. Thank you Rustc, very helpful! How do we solve it? The first logical thing I thought to do is look up sqlx transactions to see how theyâ€™re usually composed.<p>I came across <a href=https://github.com/launchbadge/sqlx/issues/1560>this</a> GitHub issue that describes a problem similar to the one I was facing.<p class=tagsData></main><footer><hr><div class=footContainer><div class=footLeft>Copyright Â© 2024 <span aria-label="rocket emoji">ðŸš€</span> Kirima</div><div class=footRight><p>Find me on</p><a href=https://github.com/kelvinkirima014 target=_blank> <img alt=GitHub class=social-icon src=https://kelvinkirima.com/github.svg> </a><a href=https://www.linkedin.com/in/kelvin-kirima-25b010184/ target=_blank> <img alt=LinkedIn class=social-icon src=https://kelvinkirima.com/linkedin.svg> </a><a href=https://twitter.com/014kirima target=_blank> <img alt=Twitter class=social-icon src=https://kelvinkirima.com/twitter.svg> </a></div></div></footer></div>